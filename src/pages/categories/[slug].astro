---
import { Image } from 'astro:assets';
import logoNaya from '../../assets/logo.svg';
import BottomNav from '../../presentation/components/BottomNav.vue';
import CartCounter from '../../presentation/components/CartCounter.vue';
import ProductCard from '../../presentation/components/ProductCard.vue';
import '../../styles/global.css';

import { FirestoreCategoryRepository } from '../../infrastructure/repositories/FirestoreCategoryRepository';
import { FirestoreProductRepository } from '../../infrastructure/repositories/FirestoreProductRepository';
import type { Category } from '../../domain/entities/Category';
import type { Product } from '../../domain/entities/Product';

const marketplaceName = import.meta.env.PUBLIC_MARKETPLACE_NAME || 'Naya';

const slug = Astro.params.slug || '';
const categoryRepo = new FirestoreCategoryRepository();
const productRepo = new FirestoreProductRepository();

let category: Category | null = null;
let products: Product[] = [];
let error: string | null = null;

try {
  category = await categoryRepo.getBySlug(slug);
  if (!category) {
    Astro.response.status = 404;
  } else {
    products = await productRepo.search({ category: category.slug || category.name });
  }
} catch (e) {
  console.error('Error loading category/products:', e);
  error = 'No se pudo cargar la categoría.';
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>{category ? `${category.name} - ${marketplaceName}` : `Categoría - ${marketplaceName}`}</title>
  </head>
  <body class="bg-[#FDFCFB] min-h-screen pb-24">
    <header class="bg-[#D9D2C8] sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <a href="/" class="p-2 hover:bg-black/5 rounded-full transition-colors" aria-label="Volver al inicio">
          <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 19l-7-7 7-7" />
          </svg>
        </a>

        <div class="flex flex-col items-center">
          <Image src={logoNaya} alt="Logo Naya" class="h-10 w-auto" />
        </div>

        <CartCounter client:only="vue" />
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
      {error ? (
        <div class="bg-error/5 border border-error/20 p-4 rounded-2xl mb-8">
          <p class="text-error text-center font-bold">{error}</p>
        </div>
      ) : !category ? (
        <div class="text-center py-24">
          <h1 class="text-2xl font-black text-gray-900 mb-2">Categoría no encontrada</h1>
          <p class="text-gray-500">La categoría que buscas no existe o fue desactivada.</p>
        </div>
      ) : (
        <>
          <div class="flex items-start justify-between gap-6 mb-8">
            <div>
              <h1 class="text-3xl font-black text-gray-900 tracking-tight">
                {category.name}
              </h1>
              {category.description ? (
                <p class="text-gray-500 mt-2 max-w-2xl leading-relaxed">{category.description}</p>
              ) : null}
            </div>
          </div>

          {products.length === 0 ? (
            <div class="text-center py-24">
              <p class="text-gray-400 font-medium italic">Aún no hay productos en esta categoría.</p>
            </div>
          ) : (
            <div class="grid grid-cols-2 gap-x-6 gap-y-10">
              {products.map((product) => (
                <ProductCard client:load product={product} />
              ))}
            </div>
          )}
        </>
      )}
    </main>

    <BottomNav client:only="vue" />
  </body>
</html>

